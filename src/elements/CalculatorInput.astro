---
import DateInput from './DateInput.astro'
import FormInput, { type Props as FormInputProps } from './FormInput.astro'
import FormSelect, { type Props as FormSelectProps } from './FormSelect.astro'
import Icon from './Icon.astro'

export const backgroundColor = 'white'

export interface Props extends FormInputProps, FormSelectProps {
  class?: string
  label?: string
  info?: string
  tag?: 'input' | 'select' | 'date'
}

const {
  class: className,
  label = 'Кол-во ворот',
  info,
  tag = 'input',
  ...rest
} = Astro.props

const Tag =
  tag === 'select' ? FormSelect : tag === 'date' ? DateInput : FormInput
---

<Tag
  {...rest}
  class={`calculator-input ${className || ''}`}
  data-has-info={info ? true : undefined}
>
  {
    info && (
      <e-calculator-input-info-button
        target-group={info}
        class="calculator-input__info-button"
        slot={'outside-label'}
      >
        <Icon
          name={'info'}
          class="calculator-input__info-button__icon"
        />
      </e-calculator-input-info-button>
    )
  }
  <span
    class="calculator-input__top"
    slot="top"
  >
    <span
      class="calculator-input__name f-d-body-large-medium-16 f-m-body-basic-medium-14"
      set:html={label}
    />
  </span>
</Tag>

<style is:global>
  .calculator-input {
    --icon-size: 2rem;

    --background-color: var(--color-grayscale-100);

    @media (max-width: 768px) {
      --icon-size: 1.4rem;
    }
  }

  .calculator-input__top {
    display: flex;
    align-items: center;
    gap: 1.5rem;

    margin-bottom: 1.45rem;

    .calculator-input[data-has-info='true'] & {
      margin-left: calc(var(--icon-size) + 1.5rem);
    }

    @media (max-width: 768px) {
      margin-bottom: 1rem;

      .calculator-input[data-has-info='true'] & {
        margin-left: calc(var(--icon-size) + 1rem);
      }
    }
  }

  .calculator-input__info-button {
    --type: toggle;

    display: block;

    position: absolute;
    top: 0;
    left: 0;

    cursor: pointer;

    width: var(--icon-size);
    height: var(--icon-size);

    @media (max-width: 768px) {
      top: 0.1rem;
    }
  }

  .calculator-input__info-button__icon {
    width: 100%;
    height: 100%;

    fill: var(--color-grayscale-600);

    .calculator-input__info-button.opened & {
      fill: var(--color-primary-100);
    }
  }
</style>

<script>
  import { PopoverButtonElement } from 'aptechka/popover'
  import type { FormSelectElement } from './FormSelect.astro.0.mts'

  export class CalculatorInputInfoButtonElement extends PopoverButtonElement {
    #selectElement: FormSelectElement | null = null

    protected override connectedCallback() {
      super.connectedCallback()

      const wrapperElement = this.closest('.calculator-input')

      if (wrapperElement?.tagName === 'E-FORM-SELECT') {
        this.#selectElement = wrapperElement as FormSelectElement

        this.#selectElement.addEventListener(
          'change',
          this.#selectChangeListener,
        )
      }

      this.#changeModal()
    }

    protected override disconnectedCallback() {
      super.disconnectedCallback()

      this.#selectElement?.removeEventListener(
        'change',
        this.#selectChangeListener,
      )
    }

    #changeModal() {
      const oldPopover = this.popoverElement

      const name = this.getAttribute('target-group')

      if (name) {
        let selector = `[data-group="${name}"]`

        const value = this.#selectElement?.value

        if (value) {
          const valueSelector = `${selector}[data-value="${value}"]`

          if (document.querySelector(valueSelector)) {
            selector = valueSelector
          }
        }

        this.changePopover(selector)

        if (this.popoverElement) {
          if (oldPopover?.opened) {
            this.popoverElement.open()
          }

          if (this.popoverElement !== oldPopover) {
            oldPopover?.close()
          }
        }
      }
    }

    #selectChangeListener = () => {
      this.#changeModal()
    }
  }

  if (!customElements.get('e-calculator-input-info-button')) {
    customElements.define(
      'e-calculator-input-info-button',
      CalculatorInputInfoButtonElement,
    )
  }

  declare global {
    interface HTMLElementTagNameMap {
      'e-calculator-input-info-button': CalculatorInputInfoButtonElement
    }
  }
</script>
